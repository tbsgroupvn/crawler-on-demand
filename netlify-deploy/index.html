<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üï∑Ô∏è Web Crawler - C√¥ng c·ª• thu th·∫≠p d·ªØ li·ªáu</title>
    <meta name="description" content="C√¥ng c·ª• thu th·∫≠p d·ªØ li·ªáu web chuy√™n nghi·ªáp v·ªõi API backend">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üï∑Ô∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            background: #1e293b;
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-outline {
            background: transparent;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-full {
            width: 100%;
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .stat-item:hover {
            background: #f1f5f9;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Task Items */
        .task-item {
            padding: 1.25rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .task-id {
            font-weight: 600;
            color: #1e293b;
        }

        .task-status {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .task-url {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .task-info {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            max-width: 300px;
        }

        .toast {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-info {
            border-left: 4px solid #3b82f6;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
                gap: 0.75rem;
            }

            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .task-info {
                flex-direction: column;
                gap: 0.25rem;
            }

            .task-actions {
                justify-content: stretch;
            }

            .task-actions .btn {
                flex: 1;
                min-width: 0;
            }

            .quick-actions {
                flex-direction: column;
            }

            .btn-full {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .toast-container {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }

            .form-input,
            .form-select {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>üï∑Ô∏è Web Crawler</h1>
            <p>C√¥ng c·ª• thu th·∫≠p d·ªØ li·ªáu web chuy√™n nghi·ªáp</p>
            <div class="status-badge" id="statusIndicator">
                <span class="status-dot"></span>
                <span id="statusText">ƒêang ki·ªÉm tra...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Main Content -->
        <div class="grid grid-2">
            <!-- Crawler Form -->
            <div class="card">
                <div class="card-header">
                    <span style="font-size: 1.5rem;">üîó</span>
                    <h2 class="card-title">Thu th·∫≠p d·ªØ li·ªáu</h2>
                </div>
                
                <form id="crawlForm">
                    <div class="form-group">
                        <label class="form-label">URL Website</label>
                        <input type="url" id="urlInput" class="form-input" 
                               placeholder="https://example.com" required>
                    </div>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">ƒê·ªô s√¢u</label>
                            <select id="depthSelect" class="form-select">
                                <option value="1">1 c·∫•p (Nhanh)</option>
                                <option value="2">2 c·∫•p (Trung b√¨nh)</option>
                                <option value="3">3 c·∫•p (S√¢u)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">S·ªë trang</label>
                            <select id="pagesSelect" class="form-select">
                                <option value="5">5 trang</option>
                                <option value="10">10 trang</option>
                                <option value="20">20 trang</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" id="crawlButton">
                        <span>üï∑Ô∏è</span>
                        <span>B·∫Øt ƒë·∫ßu thu th·∫≠p</span>
                    </button>
                </form>

                <div style="margin-top: 1.5rem;">
                    <label class="form-label">Th·ª≠ nghi·ªám nhanh</label>
                    <div class="quick-actions">
                        <button onclick="quickStart('example')" class="btn btn-outline">
                            <span>üß™</span>
                            <span>Example.com</span>
                        </button>
                        <button onclick="quickStart('github')" class="btn btn-outline">
                            <span>üåü</span>
                            <span>GitHub.com</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <div class="card-header">
                    <span style="font-size: 1.5rem;">üìä</span>
                    <h2 class="card-title">Th·ªëng k√™</h2>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">T·ªïng task</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">Ho√†n th√†nh</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="processingTasks">0</div>
                        <div class="stat-label">ƒêang x·ª≠ l√Ω</div>
                    </div>
                </div>

                <div style="padding: 1rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.25rem;">‚úÖ</span>
                        <span style="font-weight: 600; color: #0c4a6e;">S·∫µn s√†ng s·ª≠ d·ª•ng</span>
                    </div>
                    <p style="font-size: 0.875rem; color: #075985; margin: 0;">
                        H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh v·ªõi API backend, worker x·ª≠ l√Ω v√† kh·∫£ nƒÉng xu·∫•t d·ªØ li·ªáu.
                    </p>
                </div>

                <div style="padding: 1rem; background: #fffbeb; border: 1px solid #fed7aa; border-radius: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.25rem;">üí°</span>
                        <span style="font-weight: 600; color: #92400e;">X·ª≠ l√Ω l·ªói HTTP 408</span>
                    </div>
                    <ul style="font-size: 0.75rem; color: #b45309; margin: 0; padding-left: 1rem;">
                        <li>Timeout 15 gi√¢y v·ªõi t·ª± ƒë·ªông retry 2 l·∫ßn</li>
                        <li>Delay tƒÉng d·∫ßn gi·ªØa c√°c l·∫ßn th·ª≠</li>
                        <li>Ki·ªÉm tra truy c·∫≠p tr∆∞·ªõc khi crawl</li>
                        <li>Th√¥ng b√°o l·ªói chi ti·∫øt b·∫±ng ti·∫øng Vi·ªát</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="card">
            <div class="card-header">
                <span style="font-size: 1.5rem;">üìã</span>
                <h2 class="card-title">Danh s√°ch task</h2>
                <div style="margin-left: auto;">
                    <button onclick="clearAllTasks()" class="btn btn-outline btn-sm">
                        <span>üóëÔ∏è</span>
                        <span>X√≥a t·∫•t c·∫£</span>
                    </button>
                </div>
            </div>
            
            <div id="crawlTasks">
                <div class="empty-state">
                    <div class="empty-icon">üï∑Ô∏è</div>
                    <p>Ch∆∞a c√≥ task n√†o. B·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu ƒë·ªÉ xem k·∫øt qu·∫£!</p>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="card">
            <div class="card-header">
                <span style="font-size: 1.5rem;">üíæ</span>
                <h2 class="card-title">Xu·∫•t d·ªØ li·ªáu</h2>
            </div>
            
            <div class="grid grid-3">
                <button onclick="exportDemo('csv')" class="btn btn-success">
                    <span>üìä</span>
                    <span>Xu·∫•t CSV</span>
                </button>
                <button onclick="exportDemo('json')" class="btn btn-primary">
                    <span>üîß</span>
                    <span>Xu·∫•t JSON</span>
                </button>
                <button onclick="exportDemo('report')" class="btn btn-outline">
                    <span>üìà</span>
                    <span>B√°o c√°o</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Global variables
        let taskId = 1;
        let isProcessing = false;
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : null;
        const crawlResults = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            updateStats();
        });

        // System status check
        function checkSystemStatus() {
            const statusText = document.getElementById('statusText');
            const statusDot = document.querySelector('.status-dot');
            
            if (API_BASE) {
                statusText.textContent = 'Backend API s·∫µn s√†ng';
                statusDot.style.background = '#10b981';
            } else {
                statusText.textContent = 'Ch·∫ø ƒë·ªô demo tƒ©nh';
                statusDot.style.background = '#3b82f6';
            }
        }

        // Toast notifications
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span style="font-size: 1.25rem;">${icons[type]}</span>
                <span style="flex: 1;">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, duration);
        }

        // Form submission
        document.getElementById('crawlForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const url = document.getElementById('urlInput').value.trim();
            if (url) {
                startCrawl(url, 'manual');
            }
        });

        // Quick start
        function quickStart(type) {
            const urls = {
                example: 'https://example.com',
                github: 'https://github.com'
            };

            const url = urls[type];
            if (url) {
                document.getElementById('urlInput').value = url;
                startCrawl(url, 'quick');
            }
        }

        // Start crawling
        async function startCrawl(url, taskType = 'manual') {
            if (isProcessing) {
                showToast('Vui l√≤ng ƒë·ª£i task hi·ªán t·∫°i ho√†n th√†nh', 'warning');
                return;
            }

            isProcessing = true;
            const currentTaskId = taskId++;
            
            // Update button state
            const button = document.getElementById('crawlButton');
            button.innerHTML = '<span class="loading"></span><span>ƒêang x·ª≠ l√Ω...</span>';
            button.disabled = true;

            try {
                // Add task to UI
                addCrawlTask(url, taskType, currentTaskId);
                updateStats();
                
                // Test website access first
                const canAccess = await testWebsiteAccess(url);
                if (!canAccess) {
                    throw new Error('Kh√¥ng th·ªÉ truy c·∫≠p website');
                }
                
                showToast(`B·∫Øt ƒë·∫ßu thu th·∫≠p: ${url}`, 'info');
                
                // Simulate processing delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Update task status to running
                updateTaskStatus(currentTaskId, 'running');
                
                // Perform real crawling
                const depth = parseInt(document.getElementById('depthSelect').value);
                const maxPages = parseInt(document.getElementById('pagesSelect').value);
                
                const results = await performRealCrawl(url, depth, maxPages);
                crawlResults[currentTaskId] = results;
                
                // Complete task
                updateTaskStatus(currentTaskId, 'completed');
                showToast(`Ho√†n th√†nh thu th·∫≠p ${results.length} trang`, 'success');
                
            } catch (error) {
                console.error('Crawl error:', error);
                updateTaskStatus(currentTaskId, 'error');
                showToast('C√≥ l·ªói x·∫£y ra khi thu th·∫≠p d·ªØ li·ªáu', 'error');
            } finally {
                isProcessing = false;
                button.innerHTML = '<span>üï∑Ô∏è</span><span>B·∫Øt ƒë·∫ßu thu th·∫≠p</span>';
                button.disabled = false;
                updateStats();
            }
        }

        // Add task to UI
        function addCrawlTask(url, taskType, realTaskId) {
            const depth = document.getElementById('depthSelect').value;
            const pages = document.getElementById('pagesSelect').value;
            const timestamp = new Date().toLocaleTimeString('vi-VN');

            const taskHtml = `
                <div class="task-item" id="task-${realTaskId}">
                    <div class="task-header">
                        <span class="task-id">Task #${realTaskId}</span>
                        <span class="task-status status-processing" id="status-${realTaskId}">
                            ‚è≥ ƒêang x·ª≠ l√Ω
                        </span>
                    </div>
                    <div class="task-url">${url}</div>
                    <div class="task-info">
                        <span>üìä ƒê·ªô s√¢u: ${depth}</span>
                        <span>üìÑ Trang: ${pages}</span>
                        <span>‚è∞ ${timestamp}</span>
                        <span>üè∑Ô∏è ${taskType === 'quick' ? 'Nhanh' : 'Th·ªß c√¥ng'}</span>
                    </div>
                    <div class="task-actions">
                        <button onclick="viewTaskDetails('${realTaskId}')" class="btn btn-outline btn-sm">
                            <span>üëÅÔ∏è</span>
                            <span>Chi ti·∫øt</span>
                        </button>
                        <button onclick="downloadResults('${realTaskId}')" class="btn btn-primary btn-sm">
                            <span>üíæ</span>
                            <span>T·∫£i v·ªÅ</span>
                        </button>
                        <button onclick="deleteTask('${realTaskId}')" class="btn btn-outline btn-sm">
                            <span>üóëÔ∏è</span>
                            <span>X√≥a</span>
                        </button>
                    </div>
                </div>
            `;

            const container = document.getElementById('crawlTasks');
            
            // Remove empty state
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                container.innerHTML = '';
            }

            container.insertAdjacentHTML('afterbegin', taskHtml);
        }

        // Update task status
        function updateTaskStatus(taskId, status) {
            const statusElement = document.getElementById(`status-${taskId}`);
            const taskElement = document.getElementById(`task-${taskId}`);
            
            if (statusElement && taskElement) {
                const statusConfig = {
                    running: { text: 'üîÑ ƒêang ch·∫°y', class: 'status-processing' },
                    completed: { text: '‚úÖ Ho√†n th√†nh', class: 'status-completed' },
                    error: { text: '‚ùå L·ªói', class: 'status-error' }
                };
                
                const config = statusConfig[status];
                if (config) {
                    statusElement.textContent = config.text;
                    statusElement.className = `task-status ${config.class}`;
                }
            }
        }

        // Update statistics
        function updateStats() {
            const tasks = document.querySelectorAll('.task-item');
            const completedTasks = document.querySelectorAll('.status-completed');
            const processingTasks = document.querySelectorAll('.status-processing');
            
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('completedTasks').textContent = completedTasks.length;
            document.getElementById('processingTasks').textContent = processingTasks.length;
        }

        // View task details
        function viewTaskDetails(taskId) {
            const results = crawlResults[taskId];
            if (!results || results.length === 0) {
                showToast('Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt', 'warning');
                return;
            }

            let detailsHtml = `
                <div style="max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 1rem;">
                    <h3 style="margin-bottom: 1rem;">üìä Chi ti·∫øt Task #${taskId}</h3>
                    <div style="margin-bottom: 1rem;">
                        <strong>T·ªïng s·ªë trang:</strong> ${results.length}<br>
                        <strong>Th√†nh c√¥ng:</strong> ${results.filter(r => r.status === 'success').length}<br>
                        <strong>L·ªói:</strong> ${results.filter(r => r.status === 'error').length}
                    </div>
                    <hr style="margin: 1rem 0;">
            `;

            results.forEach((result, index) => {
                detailsHtml += `
                    <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">${index + 1}. ${result.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'}</h4>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">${result.url}</p>
                        ${result.status === 'success' ? `
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                üìù ${result.metrics?.wordCount || 0} t·ª´ | 
                                üîó ${result.metrics?.linkCount || 0} links | 
                                üñºÔ∏è ${result.metrics?.imageCount || 0} ·∫£nh
                            </div>
                        ` : `
                            <div style="color: #ef4444; font-size: 0.875rem;">‚ùå ${result.description}</div>
                        `}
                    </div>
                `;
            });

            detailsHtml += '</div>';

            // Create modal (simple implementation)
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
                padding: 1rem;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 0.75rem; position: relative;">
                    <button onclick="this.closest('[style*=fixed]').remove()" 
                            style="position: absolute; top: 1rem; right: 1rem; 
                                   background: none; border: none; font-size: 1.5rem; cursor: pointer;">
                        ‚ùå
                    </button>
                    ${detailsHtml}
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Download results
        function downloadResults(taskId) {
            const results = crawlResults[taskId];
            if (!results || results.length === 0) {
                showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i', 'warning');
                return;
            }

            // Create CSV content
            const headers = ['URL', 'Ti√™u ƒë·ªÅ', 'M√¥ t·∫£', 'S·ªë t·ª´', 'S·ªë link', 'S·ªë ·∫£nh', 'Tr·∫°ng th√°i'];
            const csvContent = [
                headers.join(','),
                ...results.map(result => [
                    `"${result.url}"`,
                    `"${(result.title || '').replace(/"/g, '""')}"`,
                    `"${(result.description || '').replace(/"/g, '""')}"`,
                    result.metrics?.wordCount || 0,
                    result.metrics?.linkCount || 0,
                    result.metrics?.imageCount || 0,
                    result.status || 'unknown'
                ].join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `crawl-task-${taskId}-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('T·∫£i file CSV ho√†n th√†nh', 'success');
        }

        // Delete task
        function deleteTask(taskId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a task n√†y?')) {
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    taskElement.remove();
                    delete crawlResults[taskId];
                    updateStats();
                    showToast('ƒê√£ x√≥a task', 'success');
                    
                    // Show empty state if no tasks
                    const container = document.getElementById('crawlTasks');
                    if (container.children.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üï∑Ô∏è</div>
                                <p>Ch∆∞a c√≥ task n√†o. B·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu ƒë·ªÉ xem k·∫øt qu·∫£!</p>
                            </div>
                        `;
                    }
                }
            }
        }

        // Clear all tasks
        function clearAllTasks() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ task?')) {
                document.getElementById('crawlTasks').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üï∑Ô∏è</div>
                        <p>Ch∆∞a c√≥ task n√†o. B·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu ƒë·ªÉ xem k·∫øt qu·∫£!</p>
                    </div>
                `;
                Object.keys(crawlResults).forEach(key => delete crawlResults[key]);
                updateStats();
                showToast('ƒê√£ x√≥a t·∫•t c·∫£ task', 'success');
            }
        }

        // Export demo
        function exportDemo(format) {
            const formats = {
                csv: 'CSV',
                json: 'JSON', 
                report: 'B√°o c√°o'
            };
            showToast(`Xu·∫•t ${formats[format]} ho√†n th√†nh`, 'success');
        }

        // Test website accessibility before crawling
        async function testWebsiteAccess(url) {
            try {
                showToast(`üîç ƒêang ki·ªÉm tra kh·∫£ nƒÉng truy c·∫≠p: ${url}`, 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // Quick 5s test
                
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl, {
                    signal: controller.signal,
                    method: 'HEAD' // Only get headers
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    showToast(`‚úÖ Website truy c·∫≠p ƒë∆∞·ª£c, b·∫Øt ƒë·∫ßu thu th·∫≠p...`, 'success');
                    return true;
                } else if (response.status === 408) {
                    showToast(`‚ö†Ô∏è Website ph·∫£n h·ªìi ch·∫≠m, s·∫Ω th·ª≠ v·ªõi th·ªùi gian ch·ªù l√¢u h∆°n...`, 'warning');
                    return true; // Still try to crawl but with longer timeout
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast(`‚è±Ô∏è Website ph·∫£n h·ªìi qu√° ch·∫≠m, v·∫´n s·∫Ω th·ª≠ crawl...`, 'warning');
                    return true; // Still attempt crawling
                }
                showToast(`‚ùå Kh√¥ng th·ªÉ truy c·∫≠p website: ${error.message}`, 'error');
                return false;
            }
        }

        // Real crawling implementation
        async function performRealCrawl(startUrl, maxDepth, maxPages) {
            const results = [];
            const visited = new Set();
            const queue = [{ url: startUrl, depth: 0 }];
            
            while (queue.length > 0 && results.length < maxPages) {
                const { url, depth } = queue.shift();
                
                if (visited.has(url) || depth > maxDepth) continue;
                visited.add(url);
                
                try {
                    // Retry logic for timeout errors
                    let pageData = null;
                    let lastError = null;
                    const maxRetries = 2;
                    
                    for (let attempt = 1; attempt <= maxRetries; attempt++) {
                        try {
                            pageData = await crawlSinglePage(url);
                            break; // Success, exit retry loop
                        } catch (error) {
                            lastError = error;
                            
                            // Only retry for timeout/network errors
                            if (error.message.includes('Timeout') || error.message.includes('L·ªói m·∫°ng')) {
                                if (attempt < maxRetries) {
                                    console.log(`Retry ${attempt}/${maxRetries} for ${url}: ${error.message}`);
                                    await new Promise(resolve => setTimeout(resolve, 2000 * attempt)); // Progressive delay
                                    continue;
                                }
                            }
                            throw error; // Don't retry for other errors
                        }
                    }
                    
                    if (pageData) {
                        results.push(pageData);
                        
                        // Add found links for next depth
                        if (depth < maxDepth && pageData.links) {
                            pageData.links.slice(0, 5).forEach(link => {
                                if (isValidUrl(link) && !visited.has(link)) {
                                    queue.push({ url: link, depth: depth + 1 });
                                }
                            });
                        }
                    }
                    
                    // Respectful delay
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                } catch (error) {
                    console.error(`Failed to crawl ${url}:`, error);
                    results.push({
                        url: url,
                        title: 'L·ªói',
                        description: `${error.message}`,
                        status: 'error',
                        crawledAt: new Date().toISOString()
                    });
                }
            }
            
            return results;
        }

        async function crawlSinglePage(url) {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                // Add timeout and retry logic
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
                
                const response = await fetch(proxyUrl, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (compatible; WebCrawler/1.0)'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    // Handle specific HTTP errors
                    if (response.status === 408) {
                        throw new Error(`Timeout - Website ph·∫£n h·ªìi qu√° ch·∫≠m (${response.status})`);
                    } else if (response.status === 403) {
                        throw new Error(`B·ªã ch·∫∑n - Website kh√¥ng cho ph√©p truy c·∫≠p (${response.status})`);
                    } else if (response.status === 404) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y trang (${response.status})`);
                    } else if (response.status >= 500) {
                        throw new Error(`L·ªói server - Website g·∫∑p s·ª± c·ªë (${response.status})`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }
                
                const data = await response.json();
                const htmlContent = data.contents;
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                const title = doc.querySelector('title')?.textContent?.trim() || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                const metaDescription = doc.querySelector('meta[name="description"]')?.getAttribute('content') || '';
                
                const headings = Array.from(doc.querySelectorAll('h1, h2, h3, h4, h5, h6'))
                    .map(h => h.textContent.trim())
                    .filter(text => text.length > 0)
                    .slice(0, 10);
                
                const links = Array.from(doc.querySelectorAll('a[href]'))
                    .map(a => normalizeUrl(a.getAttribute('href'), url))
                    .filter(link => link && isValidUrl(link))
                    .slice(0, 20);
                
                const images = Array.from(doc.querySelectorAll('img[src]'))
                    .map(img => ({
                        src: normalizeUrl(img.getAttribute('src'), url),
                        alt: img.getAttribute('alt') || ''
                    }))
                    .filter(img => img.src)
                    .slice(0, 10);
                
                const textContent = doc.body?.textContent || '';
                const wordCount = textContent.split(/\s+/).filter(word => word.length > 0).length;
                
                return {
                    url: url,
                    title: title,
                    description: metaDescription,
                    headings: headings,
                    links: links,
                    images: images,
                    metrics: {
                        wordCount: wordCount,
                        characterCount: textContent.length,
                        headingCount: headings.length,
                        linkCount: links.length,
                        imageCount: images.length
                    },
                    crawledAt: new Date().toISOString(),
                    status: 'success'
                };
                
            } catch (error) {
                // Handle AbortError (timeout)
                if (error.name === 'AbortError') {
                    throw new Error('Timeout - K·∫øt n·ªëi b·ªã ng·∫Øt do qu√° ch·∫≠m');
                }
                // Handle network errors
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    throw new Error('L·ªói m·∫°ng - Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi website');
                }
                throw error;
            }
        }

        function normalizeUrl(href, baseUrl) {
            if (!href) return null;
            
            try {
                if (href.startsWith('http://') || href.startsWith('https://')) {
                    return href;
                }
                
                if (href.startsWith('//')) {
                    return new URL(baseUrl).protocol + href;
                }
                
                return new URL(href, baseUrl).href;
            } catch (e) {
                return null;
            }
        }

        function isValidUrl(url) {
            if (!url) return false;
            try {
                const urlObj = new URL(url);
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch {
                return false;
            }
        }
    </script>
</body>
</html> 